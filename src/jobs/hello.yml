description: >
  Perform Appdome fusing with all types of Android and iOS signings.

parameters:
  appdome-api-token:
    type: string
    description: "Appdome-provided API token"
  appFile:
    type: string
    description: "Absolute path to your app"
  fusion-set-id:
    type: string
    description: "Fusion Set with the features you want to add to your android application."
docker:
  - image: cimg/base:current
steps:
  - checkout
  - run:
      name: Install requirements
      command: |
         sudo apt-get install jq curl

  - run:
      name: secure-app
      environment:
        APPFILE: <<parameters.appFile>>
        FUSIONSET: <<parameters.fusion-set-id>>
        APPDOME_API_TOKEN: <<parameters.appdome-api-token>>
      command: |
      echo "uploading..."
      publicLink$(curl -s --request GET \
          --url "https://fusion.appdome.com/api/v1/upload-link" \
        --header "Authorization: "${APPDOME_API_KEY}""")
      curl -s -X PUT "$(echo "$publicLink" | jq -r .url)" \
          --header 'Content-Type: application/x-compressed-tar' \
        -T "${APPFILE}"
      app=$(curl -s \
          --request POST \
        --url "https://fusion.appdome.com/api/v1/upload-using-link" \
        --header "Authorization: "${APPDOME_API_KEY}""" \
        --header 'content-type: multipart/form-data' \
        --form file_name="${APPFILE}" \
        --form file_app_id="$(echo "$publicLink" | jq -r .file_id)")


      echo "building..."
      task_id=$(
          curl -s --request POST \
            --url "https://fusion.appdome.com/api/v1/tasks" \
            --header "Authorization: "${APPDOME_API_KEY}"" \
            --header 'accept: application/json' \
            --header 'content-type: multipart/form-data' \
            --form action=fuse \
            --form fusion_set_id="${FUSIONSET}" \
            --form app_id="$(echo "$app" | jq -r .id)" |
          jq -r .task_id
        )

      statusWaiter() {
        task_id=$task_id
        status="progress"
        while [[ $status == "progress" ]]; do
          status=$(curl -s --request GET \
            --url "https://fusion.appdome.com/api/v1/tasks/$task_id/status?team_id=personal" \
            --header 'Content-Type: application/json' \
            --header "Authorization: "${APPDOME_API_KEY}"" |
            jq -r '.status')
          sleep 0.5
        done
