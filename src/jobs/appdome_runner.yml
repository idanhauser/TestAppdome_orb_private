description: >
  Perform Appdome fusing all types of android signings.

parameters:
  runner:
    description: >
      The operation to perform the fusing.
    type: enum
    enum:
      - "ANDROID_AUTO_SIGNING"
      - "ANDROID_PRIVATE_SIGNING"
      - "ANDROID_AUTO_DEV_SIGNING"
  appFile:
    type: string
    description: "Path to application"
  fusion-set-id:
    type: string
    description: "Fusion set id"
  sign-overrids:
    type: string
    default: ""
    description: "sign overrids"
  # ANDROID PRIVATE SIGN
  signing-fingerprint:
    type: string
    default: ""
    description: "Signing fingerprint"
  google-play-signing:
    type: boolean
    default: false
    description: "google play signing"
  # ANDROID AUTO SIGN
  keystore-file:
    type: string
    default: ""
  keystore-password:
    type: string
    default: ""
  keystore-alias:
    type: string
    default: ""
  keystore-key-password:
    type: string
    default: ""

docker:
  - image: cimg/python:3.9.16
steps:
  - checkout
  - run:
      name: Clone Appdome API repository
      command: |
          git clone https://github.com/Appdome/appdome-api-python.git
  - run:
      name: Install requirments
      command: <<include(scripts/install_requirements.sh)>>
  - run:
      environment:
        APPFILE: <<parameters.appFile>>
        FUSIONSET: <<parameters.fusion-set-id>>
        KEYSTORE: <<parameters.keystore-file>>
      name: Downloading files
      command: <<include(scripts/download_files.sh)>>
  - when:
      condition:
        equals: [ "ANDROID_PRIVATE_SIGNING", <<parameters.runner>> ]
      steps:
        - appdome_android_private_signing:
            appFile: <<parameters.appFile>>
            fusion-set-id: <<parameters.fusion-set-id>>
            signing-fingerprint: <<parameters.signing-fingerprint>>
            google-play-signing: <<parameters.google-play-signing>>
            sign-overrids: <<parameters.sign-overrids>>
  - when:
      condition:
        equals: [ "ANDROID_AUTO_SIGNING", <<parameters.runner>> ]
      steps:
        - appdome_android_auto_signing:
            appFile: <<parameters.appFile>>
            fusion-set-id: <<parameters.fusion-set-id>>
            keystore-file: <<parameters.keystore-file>>
            keystore-password: <<parameters.keystore-password>>
            keystore-alias: <<parameters.keystore-alias>>
            keystore-key-password: <<parameters.keystore-key-password>>
            sign-overrids: <<parameters.sign-overrids>>
  - when:
      condition:
        equals: [ "ANDROID_AUTO_DEV_SIGNING", <<parameters.runner>> ]
      steps:
        - appdome_android_private_signing:
            appFile: <<parameters.appFile>>
            fusion-set-id: <<parameters.fusion-set-id>>
            signing-fingerprint: <<parameters.signing-fingerprint>>
            google-play-signing: <<parameters.google-play-signing>>
            sign-overrids: <<parameters.sign-overrids>>